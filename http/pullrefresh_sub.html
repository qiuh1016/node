<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
	</head>

	<body>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view mui-table-view-chevron">
					
				</ul>
			</div>
		</div> 
		<script src="js/mui.min.js"></script>
		<script>
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						callback: pulldownRefresh
					},
//					up: {
//						contentrefresh: '正在加载...',
//						callback: pullupRefresh
//					}
				},
				gestureConfig:{
				   tap: true, //默认为true
				   doubletap: true, //默认为false
				   longtap: true, //默认为false
				   swipe: true, //默认为true
				   drag: true, //默认为true
				   hold:false,//默认为false，不监听
				   release:false//默认为false，不监听
				  }
			});
			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				var table = document.body.querySelector('.mui-table-view');
				var cells = document.body.querySelectorAll('.mui-table-view-cell');
				var showReportNumber = 30;
				var totalReportNumber = 0;
				var username = localStorage.username;
				var _url = '/getReportsByName';
				
				setTimeout(function() {
					mui.getJSON(_url, {limit: showReportNumber, username: username}, function(data) {
							mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
							//获得服务器响应

							
							dataJson = data;
							totalReportNumber = data.length;
							table.innerHTML = "";
							for (var i = 0; i < totalReportNumber; i++) {
								var project = data[i]['project'];
								var submitter = data[i]['submitter'];
								var add_time = makeDate(data[i]['add_time']);
								
								var li = document.createElement('li');
								li.className = 'mui-table-view-cell';
//								li.onclick = function() {
//									showDetail(i);
//								};
								li.innerHTML = '<a class="mui-navigate-right" style="font-size: 13px; color: #555555;"> ' + 
									submitter + ' - ' + project + ' - ' + add_time + '</a>';
								li.addEventListener("tap",function () {
								  showDetail(i);
								});
								table.appendChild(li)


//								var project = data[i]['project'];
//								var submitter = data[i]['submitter'];
//								var add_time = makeDate(data[i]['add_time']);
//								
//								table.innerHTML += 
//									"<li class='mui-table-view-cell' onclick='showDetail("+ i +")'>" + 
//									"<a class='mui-navigate-right' style='font-size: 13px; color: #555555;'>" +
//									submitter + "  -  " + project + "  -  " + add_time +
//									"</a></li>";
							}
							
							if	(totalReportNumber >= showReportNumber) {
								mui.toast('已显示最近提交的'+ showReportNumber+'条周报');
							} else {
								mui.toast('已显示全部'+ totalReportNumber+'条周报');
							}
							
						}
					);
				},500);
				
				
				
			}
			
			//上拉加载具体业务实现  目前未实现
			var count = 0;
			function pullupRefresh() {
				
				var table = document.body.querySelector('.mui-table-view');
				var cells = document.body.querySelectorAll('.mui-table-view-cell');
				var showReportNumber = 30;
				var totalReportNumber = 0;
				var username = localStorage.username;
				var _url = '/getReportsByName';
				
				mui.getJSON(_url, {limit: showReportNumber, username: username}, function(data) {
						mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > 2)); 
						//获得服务器响应
						dataJson = data;
						totalReportNumber = data.length;
						
						for (var i = 0; i < totalReportNumber; i++) {
							var li = document.createElement('li');
							li.className = 'mui-table-view-cell';
							li.innerHTML = '<a class="mui-navigate-right" style="font-size: 13px; color: #555555;" onclick="showDetail('+ i +')"> ' + 
							data[i]['submitter'] + ' - ' + data[i]['project'] + ' - ' + makeDate(data[i]['add_time']) +
							'</a>';
							//查入新数据 如何判断新数据
							table.insertBefore(li, table.firstChild);

						}
						
						if	(totalReportNumber >= showReportNumber) {
							mui.toast('已显示最近提交的'+ showReportNumber+'条周报');
						} else {
							mui.toast('已显示全部'+ totalReportNumber+'条周报');
						}
						
						
					}
				);
			}
		
			if (mui.os.plus) {
				mui.plusReady(function() {
					setTimeout(function() {
						mui('#pullrefresh').pullRefresh().pulldownLoading();
					}, 1000);

				});
			} else {
				mui.ready(function() {
					mui('#pullrefresh').pullRefresh().pulldownLoading();
				});
			}
			
			function showDetail(i) {
				localStorage.id = dataJson[i]['id'];
				localStorage.project = dataJson[i]['project'];
				localStorage.submitter = dataJson[i]['submitter'];
				localStorage.add_time = makeDate(dataJson[i]['add_time']);
				localStorage.importance = dataJson[i]['importance'];
				localStorage.completed = dataJson[i]['completed'];
				localStorage.issures = dataJson[i]['issures'];
				localStorage.plan = dataJson[i]['plan'];
				
				mui.openWindow({
				    url:'report_detail.html',
				});
			}
			
		</script>
		<script type="text/javascript" src="js/util.js" ></script>
	</body>

</html>